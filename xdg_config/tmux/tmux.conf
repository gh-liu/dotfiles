# https://raw.githubusercontent.com/tmux/tmux/refs/heads/master/CHANGES

# Check for true color support using:
# - `tmux info | grep -e RGB -e Tc`
#   should return:
#    197: RGB: (flag) true
#    223: Tc: (flag) true

# ============================================================================
# 1. Terminal & Colors
# ============================================================================

# default-terminal: TERM used for new panes; tmux-256color enables italics, undercurl, etc.
if-shell 'infocmp tmux-256color' 'set -g default-terminal "tmux-256color"' 'set -g default-terminal "screen-256color"'

# terminal-overrides: fix terminfo entries so apps can use italics/undercurl in tmux
# Use set -s (replace) to avoid duplicate accumulation on each source-file
set -s terminal-overrides ',*:sitm=\E[3m,*:Smulx=\E[4::%p1%dm,*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# terminal-features: enable true color (RGB), focus reporting, sync, hyperlinks
set -g terminal-features ",*:RGB:focus:sync:hyperlinks"

# ============================================================================
# 2. Server Options (Protocol-level, all sessions)
# ============================================================================

# set-clipboard: OSC 52 clipboard sync (copy in tmux â†’ system clipboard)
set -s set-clipboard on
# allow-passthrough: forward escape sequences to terminal (Kitty graphics, iTerm2 features, etc.)
set -s allow-passthrough all
# extended-keys: enable xterm-style extended key sequences (Shift+Enter, Ctrl+arrows, etc.)
set -s extended-keys on

# ============================================================================
# 3. Session Options (Session-level defaults)
# ============================================================================

# mouse: disable mouse (scroll/select/resize) to avoid accidental clicks
set -g mouse off
# mode-keys: vi-style keys in copy-mode and command-prompt
set -g mode-keys vi
# focus-events: notify apps when pane gains/loses focus (e.g. vim airline)
set -g focus-events on
# history-limit: scrollback lines per pane (default 2000)
set -g history-limit 102400
# monitor-activity: show alert when output in another pane
set -g monitor-activity on
# repeat-time: window for repeat key (ms); enables prefix+C-n C-n C-n...
set -g repeat-time 200
# escape-time: delay before prefix key is recognized (ms); 10 is tmux 3.4+ default
set -g escape-time 10
# display-time: how long status messages stay visible (ms)
set -g display-time 3000
# message-style: status line message fg/bg
set -g message-style "bg=#3B4252,fg=#A3BE8C"
# default-command: shell for new panes (unset = use default shell)
# set -g default-command "${SHELL}"

# ============================================================================
# 4. Prefix & Key Bindings
# ============================================================================

# prefix: key to enter tmux command mode (default C-b, changed to C-f)
unbind C-b
set -g prefix C-f
bind c-f send-prefix

# Edit & Reload config
bind r source-file $XDG_CONFIG_HOME/tmux/tmux.conf \; display 'tmux.conf sourced'
bind e new-window -n "tmux.conf" "\${EDITOR:-vi} $XDG_CONFIG_HOME/tmux/tmux.conf && tmux source $XDG_CONFIG_HOME/tmux/tmux.conf && tmux display \"tmux.conf sourced\""

# Session & Window control
bind c-x kill-session
bind X kill-window
bind x kill-pane

# Status line toggle
unbind t
bind t set status

# Copy mode
bind v copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Y send-keys -X copy-selection
bind -T copy-mode-vi ] send-keys -X next-prompt
bind -T copy-mode-vi [ send-keys -X previous-prompt

# Buffer/paste
unbind -T prefix p
bind p paste-buffer
bind P choose-buffer

# ============================================================================
# 5. Window & Pane Management
# ============================================================================

# Create window
bind c new-window -c "#{pane_current_path}"
bind C command-prompt -p "Name of new window: " "new-window -n '%%' -c '#{pane_current_path}'"

# Window navigation & movement
bind -r C-n next-window
bind -r C-p previous-window
bind -r \\ select-window -l
bind -r \[ swap-window -t -1\; select-window -t -1
bind -r \] swap-window -t +1\; select-window -t +1
# setw monitor-activity: per-window activity alert; C-m toggles for current window
bind C-m setw monitor-activity

# Pane split
unbind %
bind | split-window -h -c "#{pane_current_path}"
unbind \"
bind - split-window -v -c "#{pane_current_path}"
bind C-v split-window -h -c '#{pane_current_path}'
bind C-s split-window -v -c '#{pane_current_path}'

# Pane navigation
bind -r h select-pane -LZ
bind -r j select-pane -DZ
bind -r k select-pane -UZ
bind -r l select-pane -RZ

# Pane resize
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Pane move
bind -r < command-prompt -p "pane from:"  "move-pane -d -h -s '%%'"
bind -r > command-prompt -p "pane to:"    "move-pane -d -h -t '%%'"

# Duplicate pane
bind-key y run-shell '$XDG_CONFIG_HOME/tmux/scripts/_tmux_duplicate_pane.sh -h'

# Broadcast to all panes in session (-l: single prompt, no split)
unbind S
bind S command-prompt -l -p "Command(all panes in session):" \
         "run \"tmux list-panes -s -F '##{session_name}:##{window_index}.##{pane_index}' \
                | xargs -I PANE tmux send-keys -t PANE '%1' Enter\""

# Output selection
# source -q $XDG_CONFIG_HOME/tmux/output_selector.tmux

# ============================================================================
# 6. UI & Theme
# ============================================================================

# base-index: first window number (0 vs 1)
set -g base-index 1
# pane-base-index: first pane number in each window
set -g pane-base-index 1
# renumber-windows: keep window numbers sequential when one is closed
set -g renumber-windows on

# automatic-rename: rename window based on active pane
set -g automatic-rename on
# automatic-rename-format: use basename of current path as window name
set -g automatic-rename-format '#{b:pane_current_path}'

# set-titles: set terminal title (e.g. xterm title bar, iTerm tab)
set -g set-titles on
# set-titles-string: template for terminal title
set -g set-titles-string '#{pane_title}'

source -q $XDG_CONFIG_HOME/tmux/nord.tmux.conf

# ============================================================================
# 7. External Tools
# ============================================================================

# fastcopy - https://github.com/abhinav/tmux-fastcopy
# @fastcopy-action: command to run on copy; -w writes to system clipboard
set-option -g @fastcopy-action 'tmux load-buffer -w -'
# @fastcopy-regex-url: regex to match URLs for quick selection
set-option -g @fastcopy-regex-url '\b[a-z]+://[[:alnum:]\.\-\_\/]+'
bind-key f run-shell -b tmux-fastcopy

# Plugins (TPM)
# set -g @plugin 'tmux-plugins/tpm'
# set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
# run '$XDG_CONFIG_HOME/tmux/plugins/tpm/tpm'

## vim: foldmethod=marker
